{% extends "base.html" %}

{% block title %}Управление пользователями{% endblock %}

{% block content %}
<div class="container admin-users">
    <!-- Заголовок и поиск -->
    <div class="admin-header">
        <h1><i class="fas fa-users-cog"></i> Управление пользователями</h1>
        <div class="header-actions">
            <div class="search-box">
                <form method="GET" action="{{ url_for('admin_users') }}">
                    <input type="text" name="search" value="{{ search_query }}"
                           placeholder="Поиск по имени или email..." class="search-input">
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if search_query %}
                    <a href="{{ url_for('admin_users') }}" class="clear-search" title="Очистить поиск">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </form>
            </div>
            <button class="btn-add-user" onclick="showAddUserModal()">
                <i class="fas fa-user-plus"></i> Добавить пользователя
            </button>
        </div>
    </div>

    <!-- Статистика -->
    <div class="users-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ users.total }}</h3>
                <p>Всего пользователей</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon admin">
                <i class="fas fa-crown"></i>
            </div>
            <div class="stat-content">
                <h3>{{ admin_count }}</h3>
                <p>Администраторов</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon active">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <h3>{{ active_count }}</h3>
                <p>Активных сегодня</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon new">
                <i class="fas fa-user-clock"></i>
            </div>
            <div class="stat-content">
                <h3>{{ new_today }}</h3>
                <p>Новых сегодня</p>
            </div>
        </div>
    </div>

    <!-- Таблица пользователей -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th width="50">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th width="60">ID</th>
                    <th>Пользователь</th>
                    <th>Email</th>
                    <th>Роль</th>
                    <th>Регистрация</th>
                    <th>Жалоб</th>
                    <th>Статус</th>
                    <th width="150">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users.items %}
                <tr data-user-id="{{ user.id }}">
                    <td>
                        <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                    </td>
                    <td class="user-id">#{{ user.id }}</td>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                                {% if user.is_admin %}
                                <span class="admin-badge" title="Администратор">
                                    <i class="fas fa-crown"></i>
                                </span>
                                {% endif %}
                            </div>
                            <div class="user-details">
                                <strong>{{ user.username }}</strong>
                                <small>@{{ user.username|lower }}</small>
                            </div>
                        </div>
                    </td>
                    <td class="user-email">
                        {% if user.email %}
                        <a href="mailto:{{ user.email }}">{{ user.email }}</a>
                        {% else %}
                        <span class="no-email">Не указан</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_admin %}
                        <span class="role-badge admin">Администратор</span>
                        {% else %}
                        <span class="role-badge user">Пользователь</span>
                        {% endif %}
                    </td>
                    <td class="user-date">
                        {{ user.created_at.strftime('%d.%m.%Y') }}
                        <small>{{ user.created_at.strftime('%H:%M') }}</small>
                    </td>
                    <td class="user-complaints">
                        <span class="complaint-count">{{ user.complaints|length }}</span>
                        {% if user.complaints|length > 0 %}
                        <button class="btn-view-complaints" onclick="viewUserComplaints({{ user.id }})"
                                title="Показать жалобы">
                            <i class="fas fa-eye"></i>
                        </button>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="status-badge active">
                            <i class="fas fa-circle"></i> Активен
                        </span>
                        {% else %}
                        <span class="status-badge inactive">
                            <i class="fas fa-circle"></i> Неактивен
                        </span>
                        {% endif %}
                    </td>
                    <td class="user-actions">
                        <div class="action-buttons">
                            <button class="btn-action edit" onclick="editUser({{ user.id }})"
                                    title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </button>

                            {% if not user.is_admin %}
                            <button class="btn-action promote" onclick="toggleAdmin({{ user.id }})"
                                    title="Назначить администратором">
                                <i class="fas fa-user-shield"></i>
                            </button>
                            {% else %}
                            <button class="btn-action demote" onclick="toggleAdmin({{ user.id }})"
                                    title="Снять права администратора">
                                <i class="fas fa-user-slash"></i>
                            </button>
                            {% endif %}

                            {% if user.id != session.user_id %}
                            <button class="btn-action delete" onclick="deleteUser({{ user.id }})"
                                    title="Удалить пользователя">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if not users.items %}
        <div class="no-users">
            <i class="fas fa-users-slash fa-3x"></i>
            <h3>Пользователи не найдены</h3>
            <p>{% if search_query %}Попробуйте изменить поисковый запрос{% else %}Нет зарегистрированных пользователей{% endif %}</p>
        </div>
        {% endif %}
    </div>

    <!-- Пагинация -->
    {% if users.pages > 1 %}
    <div class="pagination">
        {% if users.has_prev %}
        <a href="{{ url_for('admin_users', page=users.prev_num, search=search_query) }}"
           class="page-link prev">
            <i class="fas fa-chevron-left"></i> Назад
        </a>
        {% endif %}

        <div class="page-numbers">
            {% for page_num in users.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                {% if page_num %}
                    {% if page_num == users.page %}
                    <span class="page-number active">{{ page_num }}</span>
                    {% else %}
                    <a href="{{ url_for('admin_users', page=page_num, search=search_query) }}"
                       class="page-number">{{ page_num }}</a>
                    {% endif %}
                {% else %}
                <span class="page-ellipsis">...</span>
                {% endif %}
            {% endfor %}
        </div>

        {% if users.has_next %}
        <a href="{{ url_for('admin_users', page=users.next_num, search=search_query) }}"
           class="page-link next">
            Вперед <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}

    <!-- Модальное окно добавления пользователя -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Добавить пользователя</h3>
                <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            </div>
            <form id="addUserForm" class="modal-form">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newUsername">Имя пользователя *</label>
                        <input type="text" id="newUsername" name="username" required
                               class="form-control" placeholder="username">
                        <small class="form-text">Только латинские буквы и цифры</small>
                    </div>

                    <div class="form-group">
                        <label for="newEmail">Email</label>
                        <input type="email" id="newEmail" name="email"
                               class="form-control" placeholder="user@example.com">
                    </div>

                    <div class="form-group">
                        <label for="newPassword">Пароль *</label>
                        <input type="password" id="newPassword" name="password" required
                               class="form-control" placeholder="Не менее 6 символов">
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Подтвердите пароль *</label>
                        <input type="password" id="confirmPassword" name="confirm_password" required
                               class="form-control">
                        <small id="passwordMatch" class="form-text"></small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="isAdmin" name="is_admin">
                            <span>Назначить администратором</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="send_welcome" checked>
                            <span>Отправить приветственное письмо</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal('addUserModal')">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно жалоб пользователя -->
    <div id="userComplaintsModal" class="modal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3><i class="fas fa-bullhorn"></i> Жалобы пользователя</h3>
                <span class="close" onclick="closeModal('userComplaintsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="user-complaints-list" id="userComplaintsList">
                    <!-- Контент загружается динамически -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('userComplaintsModal')">
                    <i class="fas fa-times"></i> Закрыть
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Переменные
let selectedUsers = new Set();

// Функции выбора
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedUsers.add(checkbox.value);
        } else {
            selectedUsers.delete(checkbox.value);
        }
    });

    updateSelectedCount();
}

function updateSelectedCount() {
    const count = selectedUsers.size;
    // Можно добавить отображение количества выбранных
}

// Модальные окна
function showAddUserModal() {
    document.getElementById('addUserModal').style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Проверка пароля
function checkPasswordMatch() {
    const password = document.getElementById('newPassword');
    const confirm = document.getElementById('confirmPassword');
    const matchText = document.getElementById('passwordMatch');

    if (!password || !confirm) return;

    if (confirm.value.length === 0) {
        matchText.textContent = '';
        return;
    }

    if (password.value === confirm.value) {
        matchText.textContent = '✓ Пароли совпадают';
        matchText.style.color = '#27ae60';
    } else {
        matchText.textContent = '✗ Пароли не совпадают';
        matchText.style.color = '#e74c3c';
    }
}

// Действия с пользователями
function editUser(userId) {
    // Реализация редактирования пользователя
    alert(`Редактирование пользователя #${userId}`);
}

function toggleAdmin(userId) {
    if (confirm('Изменить права администратора?')) {
        fetch(`/admin/user/${userId}/toggle_admin`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Ошибка');
            }
        })
        .catch(error => {
            alert('Ошибка сети: ' + error.message);
        });
    }
}

function deleteUser(userId) {
    if (confirm('Удалить пользователя? Это действие необратимо!')) {
        fetch(`/admin/user/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Ошибка удаления');
            }
        })
        .catch(error => {
            alert('Ошибка сети: ' + error.message);
        });
    }
}

function viewUserComplaints(userId) {
    fetch(`/api/user/${userId}/complaints`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('userComplaintsList');
            if (data.complaints && data.complaints.length > 0) {
                container.innerHTML = `
                    <div class="complaints-header">
                        <h4>${data.username} - ${data.complaints.length} жалоб</h4>
                    </div>
                    <div class="complaints-grid">
                        ${data.complaints.map(complaint => `
                            <div class="complaint-card">
                                <div class="complaint-header">
                                    <span class="category">${complaint.category}</span>
                                    <span class="status">${complaint.status}</span>
                                </div>
                                <h5>${complaint.title}</h5>
                                <p>${complaint.description.substring(0, 100)}...</p>
                                <div class="complaint-footer">
                                    <span class="date">${complaint.date}</span>
                                    <span class="votes">${complaint.votes} голосов</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="no-complaints">
                        <i class="fas fa-inbox"></i>
                        <p>У пользователя нет жалоб</p>
                    </div>
                `;
            }
            document.getElementById('userComplaintsModal').style.display = 'block';
        })
        .catch(error => {
            alert('Ошибка загрузки жалоб: ' + error.message);
        });
}

// Форма добавления пользователя
document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    // Валидация
    if (data.password.length < 6) {
        alert('Пароль должен быть не менее 6 символов');
        return;
    }

    if (data.password !== data.confirm_password) {
        alert('Пароли не совпадают');
        return;
    }

    // Отправка на сервер
    fetch('/admin/user/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Пользователь успешно добавлен');
            closeModal('addUserModal');
            location.reload();
        } else {
            alert(result.error || 'Ошибка добавления пользователя');
        }
    })
    .catch(error => {
        alert('Ошибка сети: ' + error.message);
    });
});

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    // Проверка пароля при вводе
    const confirmInput = document.getElementById('confirmPassword');
    if (confirmInput) {
        confirmInput.addEventListener('input', checkPasswordMatch);
    }

    // Закрытие модальных окон
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    };
});
</script>

<style>
.admin-users {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.admin-header h1 {
    color: #2c3e50;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

.search-box {
    position: relative;
}

.search-input {
    padding: 10px 15px;
    padding-right: 40px;
    border: 2px solid #dee2e6;
    border-radius: 25px;
    width: 300px;
    font-size: 14px;
}

.search-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
}

.clear-search {
    position: absolute;
    right: 35px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    text-decoration: none;
}

.btn-add-user {
    background: #27ae60;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Статистика */
.users-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.stat-icon { background: #3498db; }
.stat-icon.admin { background: #f39c12; }
.stat-icon.active { background: #27ae60; }
.stat-icon.new { background: #9b59b6; }

.stat-content h3 {
    margin: 0;
    font-size: 28px;
    color: #2c3e50;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #7f8c8d;
    font-size: 14px;
}

/* Таблица */
.users-table-container {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.users-table {
    width: 100%;
    border-collapse: collapse;
}

.users-table th {
    background: #f8f9fa;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #dee2e6;
}

.users-table td {
    padding: 15px;
    border-bottom: 1px solid #eee;
}

.users-table tbody tr:hover {
    background: #f8f9fa;
}

.users-table tbody tr:last-child td {
    border-bottom: none;
}

/* Стили для ячеек */
.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    position: relative;
    width: 40px;
    height: 40px;
    background: #e8f4fc;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #3498db;
}

.admin-badge {
    position: absolute;
    bottom: -3px;
    right: -3px;
    background: #f39c12;
    color: white;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    border: 2px solid white;
}

.user-details {
    display: flex;
    flex-direction: column;
}

.user-details strong {
    font-size: 16px;
    color: #2c3e50;
}

.user-details small {
    color: #95a5a6;
    font-size: 12px;
}

.user-email a {
    color: #3498db;
    text-decoration: none;
}

.user-email a:hover {
    text-decoration: underline;
}

.no-email {
    color: #95a5a6;
    font-style: italic;
}

.role-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.role-badge.admin {
    background: #fff4e6;
    color: #e67e22;
}

.role-badge.user {
    background: #e8f4fc;
    color: #3498db;
}

.user-date {
    display: flex;
    flex-direction: column;
    font-size: 14px;
}

.user-date small {
    color: #95a5a6;
    font-size: 12px;
}

.user-complaints {
    display: flex;
    align-items: center;
    gap: 8px;
}

.complaint-count {
    font-weight: 600;
    color: #2c3e50;
}

.btn-view-complaints {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: #e8f4fc;
    border: none;
    color: #3498db;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-badge.active {
    background: #e8f7ef;
    color: #27ae60;
}

.status-badge.inactive {
    background: #f1f2f6;
    color: #95a5a6;
}

.status-badge i {
    font-size: 8px;
}

/* Кнопки действий */
.action-buttons {
    display: flex;
    gap: 5px;
}

.btn-action {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    transition: all 0.3s;
}

.btn-action.edit {
    background: #3498db;
}

.btn-action.promote {
    background: #f39c12;
}

.btn-action.demote {
    background: #95a5a6;
}

.btn-action.delete {
    background: #e74c3c;
}

.btn-action:hover {
    transform: scale(1.1);
}

/* Нет пользователей */
.no-users {
    text-align: center;
    padding: 60px 20px;
    color: #95a5a6;
}

.no-users i {
    margin-bottom: 20px;
    opacity: 0.5;
}

.no-users h3 {
    margin: 0 0 10px 0;
    color: #2c3e50;
}

/* Пагинация */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 30px;
}

.page-link {
    padding: 10px 20px;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 25px;
    text-decoration: none;
    color: #2c3e50;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.page-link:hover {
    border-color: #3498db;
    color: #3498db;
}

.page-numbers {
    display: flex;
    gap: 5px;
}

.page-number {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    text-decoration: none;
    color: #2c3e50;
    font-weight: 600;
    transition: all 0.3s;
}

.page-number:hover {
    background: #e8f4fc;
    color: #3498db;
}

.page-number.active {
    background: #3498db;
    color: white;
}

.page-ellipsis {
    display: flex;
    align-items: center;
    padding: 0 10px;
    color: #95a5a6;
}

/* Модальные окна */
.modal-content.wide {
    max-width: 900px;
}

.user-complaints-list {
    min-height: 300px;
}

.complaints-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #eee;
}

.complaints-header h4 {
    margin: 0;
    color: #2c3e50;
}

.complaints-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px 0;
}

.complaint-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #dee2e6;
}

.complaint-card .complaint-header {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.complaint-card .category {
    background: #e8f4fc;
    color: #3498db;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
}

.complaint-card .status {
    background: #fff4e6;
    color: #f39c12;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
}

.complaint-card h5 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: #2c3e50;
}

.complaint-card p {
    margin: 0 0 10px 0;
    color: #6c757d;
    font-size: 13px;
    line-height: 1.4;
}

.complaint-footer {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #95a5a6;
}

.no-complaints {
    text-align: center;
    padding: 40px 20px;
    color: #95a5a6;
}

.no-complaints i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
}

/* Адаптивность */
@media (max-width: 1200px) {
    .users-table {
        display: block;
        overflow-x: auto;
    }

    .admin-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .header-actions {
        width: 100%;
    }

    .search-input {
        width: 100%;
    }
}

@media (max-width: 768px) {
    .users-stats {
        grid-template-columns: 1fr 1fr;
    }

    .action-buttons {
        flex-direction: column;
    }

    .btn-action {
        width: 28px;
        height: 28px;
        font-size: 12px;
    }
}

@media (max-width: 576px) {
    .users-stats {
        grid-template-columns: 1fr;
    }

    .pagination {
        flex-direction: column;
        gap: 10px;
    }

    .page-numbers {
        flex-wrap: wrap;
        justify-content: center;
    }
}
</style>
{% endblock %}