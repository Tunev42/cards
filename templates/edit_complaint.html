{% extends "base.html" %}

{% block title %}Редактирование жалобы{% endblock %}

{% block content %}
<div class="container">
    <div class="edit-complaint-page">
        <div class="page-header">
            <h1><i class="fas fa-edit"></i> Редактирование жалобы</h1>
            <a href="{{ url_for('complaint_detail', id=complaint.id) }}" class="back-link">
                <i class="fas fa-arrow-left"></i> Вернуться к жалобе
            </a>
        </div>

        <div class="current-info">
            <div class="info-card">
                <h3><i class="fas fa-info-circle"></i> Текущая информация</h3>
                <div class="info-row">
                    <strong>Категория:</strong>
                    <span class="badge" style="background-color: {{ complaint.category_ref.color }}20; color: {{ complaint.category_ref.color }}">
                        {{ complaint.category_ref.name }}
                    </span>
                </div>
                <div class="info-row">
                    <strong>Статус:</strong>
                    <span class="badge" style="background-color: {{ complaint.status_ref.color }}20; color: {{ complaint.status_ref.color }}">
                        {{ complaint.status_ref.name }}
                    </span>
                </div>
                <div class="info-row">
                    <strong>Создана:</strong>
                    {{ complaint.created_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                <div class="info-row">
                    <strong>Обновлена:</strong>
                    {{ complaint.updated_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                <div class="info-row">
                    <strong>Голосов:</strong>
                    {{ complaint.votes }}
                </div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('edit_complaint', id=complaint.id) }}" enctype="multipart/form-data" class="complaint-form">
            <div class="form-section">
                <h3><i class="fas fa-heading"></i> Основная информация</h3>

                <div class="form-group">
                    <label for="title">Заголовок жалобы *</label>
                    <input type="text" id="title" name="title" class="form-control"
                           value="{{ complaint.title }}" required maxlength="200">
                    <small class="form-text">Кратко опишите проблему</small>
                </div>

                <div class="form-group">
                    <label for="description">Подробное описание *</label>
                    <textarea id="description" name="description" class="form-control"
                              rows="6" required>{{ complaint.description }}</textarea>
                    <small class="form-text">Опишите проблему максимально подробно</small>
                </div>

                <div class="form-group">
                    <label for="address">Адрес проблемы</label>
                    <input type="text" id="address" name="address" class="form-control"
                           value="{{ complaint.address or '' }}" placeholder="Улица, дом, район">
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-tags"></i> Классификация</h3>

                <div class="form-group">
                    <label for="category_id">Категория проблемы *</label>
                    <select id="category_id" name="category_id" class="form-control" required>
                        {% for category in categories %}
                        <option value="{{ category.id }}"
                                {% if category.id == complaint.category_id %}selected{% endif %}
                                style="color: {{ category.color }}">
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                {% if is_admin %}
                <div class="form-group">
                    <label for="status_id">Статус решения</label>
                    <select id="status_id" name="status_id" class="form-control">
                        {% for status in statuses %}
                        <option value="{{ status.id }}"
                                {% if status.id == complaint.status_id %}selected{% endif %}
                                style="color: {{ status.color }}">
                            {{ status.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-text">Только администратор может менять статус</small>
                </div>
                {% endif %}
            </div>

            <div class="form-section">
                <h3><i class="fas fa-camera"></i> Фотография</h3>

                <div class="current-photo">
                    {% if complaint.photo %}
                    <h4>Текущая фотография:</h4>
                    <div class="photo-container">
                        <img src="{{ url_for('static', filename='uploads/' + complaint.photo) }}"
                             alt="Текущее фото" class="current-image">
                        <div class="photo-info">
                            <p>Фотография загружена: {{ complaint.created_at.strftime('%d.%m.%Y') }}</p>
                            <div class="photo-actions">
                                <a href="{{ url_for('static', filename='uploads/' + complaint.photo) }}"
                                   target="_blank" class="btn-view">
                                    <i class="fas fa-expand"></i> Открыть в полном размере
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="delete_photo" value="1">
                            <span>Удалить текущую фотографию</span>
                        </label>
                    </div>
                    {% else %}
                    <div class="no-photo">
                        <i class="fas fa-camera-slash fa-2x"></i>
                        <p>Фотография не загружена</p>
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="photo">Новая фотография</label>
                    <input type="file" id="photo" name="photo" class="form-control" accept="image/*">
                    <small class="form-text">
                        Загрузите новую фотографию проблемы. Максимальный размер: 5MB.
                        Форматы: JPG, PNG, GIF.
                    </small>

                    <div class="image-preview" id="imagePreview">
                        <img src="" alt="Предпросмотр" class="preview-image">
                        <span class="preview-text">Предпросмотр новой фотографии</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-exclamation-triangle"></i> Важная информация</h3>

                <div class="alert alert-warning">
                    <h4><i class="fas fa-info-circle"></i> Внимание!</h4>
                    <ul>
                        <li>После сохранения изменений история редактирования будет сохранена</li>
                        <li>Дата обновления жалобы изменится на текущую</li>
                        <li>Если вы администратор, изменение статуса уведомит автора жалобы</li>
                        <li>Удаление фотографии необратимо</li>
                    </ul>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-submit">
                    <i class="fas fa-save"></i> Сохранить изменения
                </button>

                <a href="{{ url_for('complaint_detail', id=complaint.id) }}" class="btn-cancel">
                    <i class="fas fa-times"></i> Отмена
                </a>

                {% if is_admin %}
                <button type="button" class="btn-delete" onclick="showDeleteModal()">
                    <i class="fas fa-trash"></i> Удалить жалобу
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Подтверждение удаления</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Вы уверены, что хотите удалить эту жалобу?</p>
            <p><strong>Это действие необратимо!</strong></p>
            <ul>
                <li>Жалоба будет удалена без возможности восстановления</li>
                <li>Все комментарии к жалобе также будут удалены</li>
                <li>Фотография будет удалена с сервера</li>
            </ul>
        </div>
        <div class="modal-footer">
            <form method="POST" action="{{ url_for('delete_complaint', id=complaint.id) }}" id="deleteForm">
                <button type="button" class="btn-cancel" onclick="closeModal()">
                    <i class="fas fa-times"></i> Отмена
                </button>
                <button type="submit" class="btn-delete-confirm">
                    <i class="fas fa-trash"></i> Да, удалить
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Предпросмотр фото
const photoInput = document.getElementById('photo');
const previewContainer = document.getElementById('imagePreview');
const previewImage = previewContainer.querySelector('.preview-image');
const previewText = previewContainer.querySelector('.preview-text');

if (photoInput) {
    photoInput.addEventListener('change', function() {
        const file = this.files[0];

        if (file) {
            const reader = new FileReader();

            previewText.style.display = 'none';
            previewImage.style.display = 'block';

            reader.addEventListener('load', function() {
                previewImage.setAttribute('src', this.result);
            });

            reader.readAs
}
else {
previewText.style.display = 'block';
previewImage.style.display = 'none';
previewImage.setAttribute('src', '');
}
});
}

// Модальное окно удаления
function showDeleteModal() {
const modal = document.getElementById('deleteModal');
if (modal) {
modal.style.display = 'block';
}
}

function closeModal() {
const modal = document.getElementById('deleteModal');
if (modal) {
modal.style.display = 'none';
}
}

// Закрытие модального окна при клике вне его
window.onclick = function(event) {
const modal = document.getElementById('deleteModal');
if (modal && event.target === modal) {
modal.style.display = 'none';
}
}

// Подтверждение при обновлении формы
const form = document.querySelector('.complaint-form');
if (form) {
form.addEventListener('submit', function(e) {
const title = document.getElementById('title').value.trim();
const description = document.getElementById('description').value.trim();

// Подтверждение удаления фото
const deletePhotoCheckbox = document.querySelector('input[name="delete_photo"]');
if (deletePhotoCheckbox) {
deletePhotoCheckbox.addEventListener('change', function() {
if (this.checked) {
const confirmed = confirm('Вы уверены, что хотите удалить текущую фотографию? Это действие необратимо.');
if (!confirmed) {
this.checked = false;
}
}
});
}

// Показывать/скрывать предпросмотр
if (previewContainer) {
previewContainer.style.display = 'none';
photoInput.addEventListener('change', function() {
if (this.files.length > 0) {
previewContainer.style.display = 'block';
} else {
previewContainer.style.display = 'none';
}
});
}
</script>

<style> /* Стили для предпросмотра изображения */ .image-preview { margin-top: 15px; display: none; border: 2px dashed #ddd; border-radius: 8px; padding: 15px; text-align: center; background-color: #f9f9f9; } .preview-image { max-width: 100%; max-height: 300px; display: none; margin: 0 auto; border-radius: 4px; } .preview-text { color: #666; font-style: italic; } /* Стили для текущего фото */ .current-photo { margin-bottom: 20px; } .photo-container { display: flex; gap: 20px; align-items: flex-start; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; } .current-image { max-width: 300px; max-height: 200px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .photo-info { flex: 1; } .photo-actions { margin-top: 10px; } .btn-view { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.3s; } .btn-view:hover { background: #0056b3; color: white; text-decoration: none; } .no-photo { text-align: center; padding: 30px; color: #6c757d; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6; } .no-photo i { margin-bottom: 10px; color: #adb5bd; } /* Чекбокс удаления фото */ .checkbox-label { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; cursor: pointer; } .checkbox-label input { width: 18px; height: 18px; } /* Модальное окно */ .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); } .modal-content { background-color: white; margin: 5% auto; padding: 0; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); animation: modalSlideIn 0.3s; } @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .modal-header { padding: 20px; background: #f8d7da; border-bottom: 1px solid #f5c6cb; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; } .modal-header h3 { margin: 0; color: #721c24; font-size: 18px; } .close { color: #721c24; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; } .close:hover { color: #491217; } .modal-body { padding: 20px; } .modal-body ul { margin: 10px 0 0 20px; color: #856404; } .modal-body li { margin-bottom: 5px; } .modal-footer { padding: 20px; background: #f8f9fa; border-top: 1px solid #e9ecef; border-radius: 0 0 8px 8px; display: flex; justify-content: flex-end; gap: 10px; } .btn-delete-confirm { background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; transition: background 0.3s; } .btn-delete-confirm:hover { background: #c82333; } /* Респонсив стили */ @media (max-width: 768px) { .photo-container { flex-direction: column; align-items: center; text-align: center; } .current-image { max-width: 100%; } .modal-content { margin: 10% auto; width: 95%; } .modal-footer { flex-direction: column; } .modal-footer button { width: 100%; } } @media (max-width: 576px) { .form-actions { flex-direction: column; } .form-actions button, .form-actions a { width: 100%; margin: 5px 0; } } </style>
{% endblock %}