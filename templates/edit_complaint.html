{% extends "base.html" %}

{% block title %}Редактирование жалобы{% endblock %}

{% block content %}
<div class="container">
    <div class="edit-complaint-page">
        <div class="page-header">
            <h1><i class="fas fa-edit"></i> Редактирование жалобы</h1>
            <a href="{{ url_for('complaint_detail', id=complaint.id) }}" class="back-link">
                <i class="fas fa-arrow-left"></i> Вернуться к жалобе
            </a>
        </div>

        <div class="current-info">
            <div class="info-card">
                <h3><i class="fas fa-info-circle"></i> Текущая информация</h3>
                <div class="info-row">
                    <strong>Категория:</strong>
                    <span class="badge" style="background-color: {{ complaint.category_ref.color }}20; color: {{ complaint.category_ref.color }}">
                        {{ complaint.category_ref.name }}
                    </span>
                </div>
                <div class="info-row">
                    <strong>Статус:</strong>
                    <span class="badge" style="background-color: {{ complaint.status_ref.color }}20; color: {{ complaint.status_ref.color }}">
                        {{ complaint.status_ref.name }}
                    </span>
                </div>
                <div class="info-row">
                    <strong>Создана:</strong>
                    {{ complaint.created_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                <div class="info-row">
                    <strong>Обновлена:</strong>
                    {{ complaint.updated_at.strftime('%d.%m.%Y %H:%M') }}
                </div>
                <div class="info-row">
                    <strong>Голосов:</strong>
                    {{ complaint.votes }}
                </div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('edit_complaint', id=complaint.id) }}" enctype="multipart/form-data" class="complaint-form">
            <div class="form-section">
                <h3><i class="fas fa-heading"></i> Основная информация</h3>

                <div class="form-group">
                    <label for="title">Заголовок жалобы *</label>
                    <input type="text" id="title" name="title" class="form-control"
                           value="{{ complaint.title }}" required maxlength="200">
                    <small class="form-text">Кратко опишите проблему</small>
                </div>

                <div class="form-group">
                    <label for="description">Подробное описание *</label>
                    <textarea id="description" name="description" class="form-control"
                              rows="6" required>{{ complaint.description }}</textarea>
                    <small class="form-text">Опишите проблему максимально подробно</small>
                </div>

                <div class="form-group">
                    <label for="address">Адрес проблемы</label>
                    <input type="text" id="address" name="address" class="form-control"
                           value="{{ complaint.address or '' }}" placeholder="Улица, дом, район">
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-tags"></i> Классификация</h3>

                <div class="form-group">
                    <label for="category_id">Категория проблемы *</label>
                    <select id="category_id" name="category_id" class="form-control" required>
                        {% for category in categories %}
                        <option value="{{ category.id }}"
                                {% if category.id == complaint.category_id %}selected{% endif %}
                                style="color: {{ category.color }}">
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                {% if is_admin %}
                <div class="form-group">
                    <label for="status_id">Статус решения</label>
                    <select id="status_id" name="status_id" class="form-control">
                        {% for status in statuses %}
                        <option value="{{ status.id }}"
                                {% if status.id == complaint.status_id %}selected{% endif %}
                                style="color: {{ status.color }}">
                            {{ status.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-text">Только администратор может менять статус</small>
                </div>
                {% endif %}
            </div>

            <div class="form-section">
                <h3><i class="fas fa-camera"></i> Фотография</h3>

                <div class="current-photo">
                    {% if complaint.photo %}
                    <h4>Текущая фотография:</h4>
                    <div class="photo-container">
                        <img src="{{ url_for('static', filename='uploads/' + complaint.photo) }}"
                             alt="Текущее фото" class="current-image">
                        <div class="photo-info">
                            <p>Фотография загружена: {{ complaint.created_at.strftime('%d.%m.%Y') }}</p>
                            <div class="photo-actions">
                                <a href="{{ url_for('static', filename='uploads/' + complaint.photo) }}"
                                   target="_blank" class="btn-view">
                                    <i class="fas fa-expand"></i> Открыть в полном размере
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="delete_photo" value="1">
                            <span>Удалить текущую фотографию</span>
                        </label>
                    </div>
                    {% else %}
                    <div class="no-photo">
                        <i class="fas fa-camera-slash fa-2x"></i>
                        <p>Фотография не загружена</p>
                    </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="photo">Новая фотография</label>
                    <input type="file" id="photo" name="photo" class="form-control" accept="image/*">
                    <small class="form-text">
                        Загрузите новую фотографию проблемы. Максимальный размер: 5MB.
                        Форматы: JPG, PNG, GIF.
                    </small>

                    <div class="image-preview" id="imagePreview">
                        <img src="" alt="Предпросмотр" class="preview-image">
                        <span class="preview-text">Предпросмотр новой фотографии</span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3><i class="fas fa-exclamation-triangle"></i> Важная информация</h3>

                <div class="alert alert-warning">
                    <h4><i class="fas fa-info-circle"></i> Внимание!</h4>
                    <ul>
                        <li>После сохранения изменений история редактирования будет сохранена</li>
                        <li>Дата обновления жалобы изменится на текущую</li>
                        <li>Если вы администратор, изменение статуса уведомит автора жалобы</li>
                        <li>Удаление фотографии необратимо</li>
                    </ul>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-submit">
                    <i class="fas fa-save"></i> Сохранить изменения
                </button>

                <a href="{{ url_for('complaint_detail', id=complaint.id) }}" class="btn-cancel">
                    <i class="fas fa-times"></i> Отмена
                </a>

                {% if is_admin %}
                <button type="button" class="btn-delete" onclick="showDeleteModal()">
                    <i class="fas fa-trash"></i> Удалить жалобу
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Подтверждение удаления</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Вы уверены, что хотите удалить эту жалобу?</p>
            <p><strong>Это действие необратимо!</strong></p>
            <ul>
                <li>Жалоба будет удалена без возможности восстановления</li>
                <li>Все комментарии к жалобе также будут удалены</li>
                <li>Фотография будет удалена с сервера</li>
            </ul>
        </div>
        <div class="modal-footer">
            <form method="POST" action="{{ url_for('delete_complaint', id=complaint.id) }}" id="deleteForm">
                <button type="button" class="btn-cancel" onclick="closeModal()">
                    <i class="fas fa-times"></i> Отмена
                </button>
                <button type="submit" class="btn-delete-confirm">
                    <i class="fas fa-trash"></i> Да, удалить
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Предпросмотр фото
const photoInput = document.getElementById('photo');
const previewContainer = document.getElementById('imagePreview');
const previewImage = previewContainer.querySelector('.preview-image');
const previewText = previewContainer.querySelector('.preview-text');

if (photoInput) {
    photoInput.addEventListener('change', function() {
        const file = this.files[0];

        if (file) {
            const reader = new FileReader();

            previewText.style.display = 'none';
            previewImage.style.display = 'block';

            reader.addEventListener('load', function() {
                previewImage.setAttribute('src', this.result);
            });

            reader.readAs