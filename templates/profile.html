{% extends "base.html" %}

{% block title %}Профиль пользователя{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-page">
        <!-- Шапка профиля -->
        <div class="profile-header">
            <div class="profile-avatar">
                <div class="avatar-circle">
                    <i class="fas fa-user fa-2x"></i>
                </div>
                <div class="avatar-badge {% if user.is_admin %}admin-badge{% endif %}">
                    {% if user.is_admin %}
                    <i class="fas fa-crown"></i>
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                </div>
            </div>

            <div class="profile-info">
                <h1>{{ user.username }}</h1>
                <div class="profile-meta">
                    <span class="meta-item">
                        <i class="fas fa-envelope"></i>
                        {{ user.email or 'Email не указан' }}
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-calendar-plus"></i>
                        Зарегистрирован {{ user.created_at.strftime('%d.%m.%Y') }}
                    </span>
                    {% if user.is_admin %}
                    <span class="meta-item admin-tag">
                        <i class="fas fa-shield-alt"></i>
                        Администратор
                    </span>
                    {% endif %}
                </div>

                <div class="profile-actions">
                    <a href="{{ url_for('edit_profile') }}" class="btn-edit">
                        <i class="fas fa-edit"></i> Редактировать профиль
                    </a>
                    {% if user.is_admin %}
                    <a href="{{ url_for('admin_dashboard') }}" class="btn-admin">
                        <i class="fas fa-cog"></i> Панель администратора
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div class="profile-stats">
            <h2><i class="fas fa-chart-bar"></i> Статистика</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #3498db20; color: #3498db;">
                        <i class="fas fa-bullhorn"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.total_complaints }}</h3>
                        <p>Жалоб отправлено</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #27ae6020; color: #27ae60;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.solved_complaints }}</h3>
                        <p>Решённых проблем</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #9b59b620; color: #9b59b6;">
                        <i class="fas fa-thumbs-up"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.total_votes }}</h3>
                        <p>Всего голосов</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background-color: #e74c3c20; color: #e74c3c;">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ stats.total_comments }}</h3>
                        <p>Комментариев</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Последние жалобы -->
        <div class="recent-complaints">
            <div class="section-header">
                <h2><i class="fas fa-history"></i> Последние жалобы</h2>
                <a href="{{ url_for('add_complaint') }}" class="btn-add">
                    <i class="fas fa-plus"></i> Новая жалоба
                </a>
            </div>

            {% if complaints %}
            <div class="complaints-list">
                {% for complaint in complaints %}
                <div class="complaint-card">
                    <div class="complaint-header">
                        <span class="complaint-category"
                              style="background-color: {{ complaint.category_ref.color }}20;
                                     color: {{ complaint.category_ref.color }}">
                            <i class="{{ complaint.category_ref.icon }}"></i>
                            {{ complaint.category_ref.name }}
                        </span>

                        <span class="complaint-status"
                              style="background-color: {{ complaint.status_ref.color }}20;
                                     color: {{ complaint.status_ref.color }}">
                            <i class="{{ complaint.status_ref.icon }}"></i>
                            {{ complaint.status_ref.name }}
                        </span>

                        <span class="complaint-date">
                            {{ complaint.created_at.strftime('%d.%m.%Y') }}
                        </span>
                    </div>

                    <h3 class="complaint-title">
                        <a href="{{ url_for('complaint_detail', id=complaint.id) }}">
                            {{ complaint.title }}
                        </a>
                    </h3>

                    <p class="complaint-description">
                        {{ complaint.description|truncate(150) }}
                    </p>

                    {% if complaint.address %}
                    <p class="complaint-address">
                        <i class="fas fa-map-marker-alt"></i> {{ complaint.address }}
                    </p>
                    {% endif %}

                    <div class="complaint-footer">
                        <div class="complaint-stats">
                            <span class="stat">
                                <i class="fas fa-thumbs-up"></i>
                                {{ complaint.votes }}
                            </span>
                            <span class="stat">
                                <i class="fas fa-eye"></i>
                                {{ complaint.views }}
                            </span>
                            <span class="stat">
                                <i class="fas fa-comment"></i>
                                {{ complaint.comments|length }}
                            </span>
                        </div>

                        <div class="complaint-actions">
                            <a href="{{ url_for('complaint_detail', id=complaint.id) }}"
                               class="btn-view">
                                <i class="fas fa-eye"></i> Просмотр
                            </a>
                            {% if session.user_id == complaint.user_id %}
                            <a href="{{ url_for('edit_complaint', id=complaint.id) }}"
                               class="btn-edit-small">
                                <i class="fas fa-edit"></i> Редактировать
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="view-all">
                <a href="{{ url_for('index') }}?user={{ user.id }}" class="btn-view-all">
                    <i class="fas fa-list"></i> Показать все жалобы
                </a>
            </div>
            {% else %}
            <div class="no-complaints">
                <i class="fas fa-inbox fa-3x"></i>
                <h3>У вас пока нет жалоб</h3>
                <p>Добавьте первую жалобу, чтобы начать улучшать город!</p>
                <a href="{{ url_for('add_complaint') }}" class="btn-primary">
                    <i class="fas fa-plus"></i> Добавить первую жалобу
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Статистика по категориям -->
        <div class="category-stats">
            <h2><i class="fas fa-chart-pie"></i> Статистика по категориям</h2>
            <div class="categories-chart">
                {% set category_stats = {} %}
                {% for complaint in user.complaints %}
                    {% set category_name = complaint.category_ref.name %}
                    {% if category_name not in category_stats %}
                        {% set _ = category_stats.update({category_name: 1}) %}
                    {% else %}
                        {% set _ = category_stats.update({category_name: category_stats[category_name] + 1}) %}
                    {% endif %}
                {% endfor %}

                {% if category_stats %}
                <div class="chart-container">
                    {% for category_name, count in category_stats.items() %}
                    {% set category = categories|selectattr('name', 'equalto', category_name)|first %}
                    <div class="chart-item">
                        <div class="chart-bar-container">
                            <div class="chart-bar"
                                 style="width: {{ (count / user.complaints|length * 100)|round|int }}%;
                                        background-color: {{ category.color if category else '#95a5a6' }};">
                            </div>
                        </div>
                        <div class="chart-label">
                            <span class="chart-color"
                                  style="background-color: {{ category.color if category else '#95a5a6' }}"></span>
                            <span class="chart-name">{{ category_name }}</span>
                            <span class="chart-count">{{ count }} ({{ ((count / user.complaints|length * 100)|round|int) }}%)</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-stats">
                    <p>Нет данных для построения графика</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Дополнительные настройки -->
        <div class="profile-settings">
            <h2><i class="fas fa-cog"></i> Настройки</h2>
            <div class="settings-grid">
                <div class="setting-card">
                    <div class="setting-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Безопасность</h3>
                        <p>Смена пароля и настройки безопасности</p>
                    </div>
                    <a href="{{ url_for('edit_profile') }}" class="setting-action">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>

                <div class="setting-card">
                    <div class="setting-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Уведомления</h3>
                        <p>Настройка email и push-уведомлений</p>
                    </div>
                    <button class="setting-action" onclick="showNotificationsSettings()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="setting-card">
                    <div class="setting-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Приватность</h3>
                        <p>Кто может видеть ваши жалобы и комментарии</p>
                    </div>
                    <button class="setting-action" onclick="showPrivacySettings()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="setting-card">
                    <div class="setting-icon">
                        <i class="fas fa-bookmark"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Закладки</h3>
                        <p>Сохранённые жалобы и избранное</p>
                    </div>
                    <button class="setting-action" onclick="showBookmarks()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Быстрые действия -->
        <div class="quick-actions">
            <h2><i class="fas fa-bolt"></i> Быстрые действия</h2>
            <div class="actions-grid">
                <a href="{{ url_for('add_complaint') }}" class="action-card add">
                    <i class="fas fa-plus"></i>
                    <span>Добавить жалобу</span>
                </a>

                <a href="{{ url_for('index') }}" class="action-card browse">
                    <i class="fas fa-search"></i>
                    <span>Найти жалобы</span>
                </a>

                <button class="action-card share" onclick="shareProfile()">
                    <i class="fas fa-share-alt"></i>
                    <span>Поделиться профилем</span>
                </button>

                <a href="{{ url_for('logout') }}" class="action-card logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Выйти</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Поделиться профилем
function shareProfile() {
    const shareData = {
        title: 'Профиль пользователя {{ user.username }}',
        text: 'Посмотрите профиль на Портале жалоб',
        url: window.location.href
    };

    if (navigator.share) {
        navigator.share(shareData);
    } else {
        navigator.clipboard.writeText(window.location.href);
        alert('Ссылка на профиль скопирована в буфер обмена!');
    }
}

// Настройки уведомлений
function showNotificationsSettings() {
    alert('Настройки уведомлений скоро будут доступны!');
}

// Настройки приватности
function showPrivacySettings() {
    alert('Настройки приватности скоро будут доступны!');
}

// Показать закладки
function showBookmarks() {
    alert('Закладки скоро будут доступны!');
}

// Анимация при наведении на статистику
document.querySelectorAll('.stat-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
    });

    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
    });
});
</script>

<style>
/* Стили для профиля */
.profile-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 30px;
    margin-bottom: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
    position: relative;
    overflow: hidden;
}

.profile-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    opacity: 0.3;
}

.profile-avatar {
    position: relative;
    z-index: 1;
}

.avatar-circle {
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.2);
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.avatar-badge {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #764ba2;
}

.admin-badge {
    background: linear-gradient(135deg, #f39c12, #e74c3c);
    color: white;
}

.profile-info h1 {
    margin: 0 0 10px 0;
    font-size: 36px;
    z-index: 1;
    position: relative;
}

.profile-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
    z-index: 1;
    position: relative;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 15px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
}

.admin-tag {
    background: rgba(243, 156, 18, 0.3);
}

.profile-actions {
    display: flex;
    gap: 15px;
    z-index: 1;
    position: relative;
}

.btn-edit, .btn-admin {
    padding: 12px 25px;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-edit {
    background: white;
    color: #764ba2;
}

.btn-admin {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.btn-edit:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-admin:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Статистика */
.profile-stats {
    margin: 40px 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.stat-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
}

.stat-content h3 {
    margin: 0;
    font-size: 32px;
    color: #2c3e50;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #7f8c8d;
}

/* Стили для списка жалоб */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 40px 0 20px 0;
}

.btn-add {
    background: #27ae60;
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

.complaint-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    border-left: 5px solid #3498db;
    transition: all 0.3s;
}

.complaint-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.complaint-header {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.complaint-category, .complaint-status {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.complaint-date {
    color: #95a5a6;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.complaint-title a {
    color: #2c3e50;
    text-decoration: none;
    font-size: 22px;
    margin: 0 0 10px 0;
    display: block;
}

.complaint-title a:hover {
    color: #3498db;
}

.complaint-description {
    color: #34495e;
    line-height: 1.6;
    margin: 10px 0;
}

.complaint-address {
    color: #7f8c8d;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.complaint-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.complaint-stats {
    display: flex;
    gap: 20px;
}

.complaint-stats .stat {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #7f8c8d;
    font-size: 14px;
}

.complaint-actions {
    display: flex;
    gap: 10px;
}

.btn-view, .btn-edit-small {
    padding: 8px 15px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
}

.btn-view {
    background: #3498db;
    color: white;
}

.btn-edit-small {
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
}

.view-all {
    text-align: center;
    margin: 30px 0;
}

.btn-view-all {
    background: #95a5a6;
    color: white;
    padding: 12px 30px;
    border-radius: 25px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.no-complaints {
    text-align: center;
    padding: 50px 20px;
    background: #f8f9fa;
    border-radius: 15px;
    color: #6c757d;
}

.no-complaints i {
    margin-bottom: 20px;
    color: #dee2e6;
}

/* Статистика по категориям */
.category-stats {
    margin: 40px 0;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}

.chart-container {
    margin-top: 20px;
}

.chart-item {
    margin-bottom: 15px;
}

.chart-bar-container {
    height: 30px;
    background: #f8f9fa;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 8px;
}

.chart-bar {
    height: 100%;
    border-radius: 15px;
    transition: width 1s ease-in-out;
}

.chart-label {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chart-color {
    width: 15px;
    height: 15px;
    border-radius: 50%;
}

.chart-name {
    flex-grow: 1;
    font-weight: 600;
}

.chart-count {
    color: #6c757d;
    font-size: 14px;
}

/* Настройки профиля */
.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.setting-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s;
}

.setting-card:hover {
    border-color: #3498db;
    transform: translateX(5px);
}

.setting-icon {
    width: 50px;
    height: 50px;
    background: #f8f9fa;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #3498db;
    font-size: 20px;
}

.setting-content {
    flex-grow: 1;
}

.setting-content h3 {
    margin: 0 0 5px 0;
    font-size: 18px;
}

.setting-content p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
}

.setting-action {
    background: none;
    border: none;
    color: #6c757d;
    font-size: 18px;
    cursor: pointer;
    padding: 10px;
}

/* Быстрые действия */
.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.action-card {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 25px;
    text-align: center;
    text-decoration: none;
    color: #2c3e50;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.action-card i {
    font-size: 30px;
    margin-bottom: 10px;
}

.action-card.add {
    border-color: #27ae60;
    color: #27ae60;
}

.action-card.browse {
    border-color: #3498db;
    color: #3498db;
}

.action-card.share {
    border-color: #9b59b6;
    color: #9b59b6;
    cursor: pointer;
}

.action-card.logout {
    border-color: #e74c3c;
    color: #e74c3c;
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.action-card.add:hover {
    background: #27ae60;
    color: white;
}

.action-card.browse:hover {
    background: #3498db;
    color: white;
}

.action-card.share:hover {
    background: #9b59b6;
    color: white;
}

.action-card.logout:hover {
    background: #e74c3c;
    color: white;
}

/* Адаптивность */
@media (max-width: 768px) {
    .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }

    .profile-meta {
        justify-content: center;
    }

    .profile-actions {
        justify-content: center;
        flex-wrap: wrap;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .complaint-footer {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }

    .complaint-actions {
        justify-content: center;
    }

    .actions-grid {
        grid-template-columns: 1fr 1fr;
    }
}

@media (max-width: 480px) {
    .actions-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}