{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Шапка с кнопкой добавления -->
    <div class="header-actions">
        <h1 class="page-title">Жалобы от жителей</h1>
        <a href="{{ url_for('add_complaint') }}" class="add-complaint-btn">
            <i class="fas fa-plus"></i> Добавить жалобу
        </a>
    </div>

    <!-- Фильтры по категориям -->
    <div class="filters-section">
        <h3 class="filters-title">
            <i class="fas fa-filter"></i> Категории проблем
        </h3>
        <div class="category-filters">
            <button class="filter-btn {% if current_category == '' %}active{% endif %}"
                    onclick="setCategory('')">
                <i class="fas fa-globe"></i> Все проблемы
                <span class="filter-count">{{ complaints|length }}</span>
            </button>

            {% for category in categories %}
            <button class="filter-btn category-{{ category|lower }} {% if current_category == category %}active{% endif %}"
                    onclick="setCategory('{{ category }}')">
                <i class="fas fa-{{
                    'road' if category == 'Дороги' else
                    'trash' if category == 'Мусор' else
                    'lightbulb' if category == 'Освещение' else
                    'tint' if category == 'Вода' else
                    'bus' if category == 'Транспорт' else
                    'question-circle'
                }}"></i>
                {{ category }}
                <span class="filter-count">{{ stats[category] }}</span>
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Фильтры по статусу -->
    <div class="filters-section">
        <h3 class="filters-title">
            <i class="fas fa-tasks"></i> Статус решения
        </h3>
        <div class="status-filters">
            <button class="status-btn {% if current_status == '' %}active{% endif %}"
                    onclick="setStatus('')">
                Все статусы
            </button>

            <button class="status-btn status-new {% if current_status == 'Новая' %}active{% endif %}"
                    onclick="setStatus('Новая')">
                <i class="fas fa-clock"></i> Новые
                <span class="filter-count">{{ stats['Новая'] if stats['Новая'] else 0 }}</span>
            </button>

            <button class="status-btn status-inwork {% if current_status == 'В работе' %}active{% endif %}"
                    onclick="setStatus('В работе')">
                <i class="fas fa-tools"></i> В работе
                <span class="filter-count">{{ stats['В работе'] if stats['В работе'] else 0 }}</span>
            </button>

            <button class="status-btn status-done {% if current_status == 'Исправлено' %}active{% endif %}"
                    onclick="setStatus('Исправлено')">
                <i class="fas fa-check-circle"></i> Исправлено
                <span class="filter-count">{{ stats['Исправлено'] if stats['Исправлено'] else 0 }}</span>
            </button>
        </div>
    </div>

    <!-- Сортировка -->
    <div class="sort-section">
        <h3 class="filters-title">
            <i class="fas fa-sort-amount-down"></i> Сортировка
        </h3>
        <div class="sort-options">
            <button class="sort-btn {% if current_sort == 'newest' %}active{% endif %}"
                    onclick="setSort('newest')">
                <i class="fas fa-calendar-plus"></i> Сначала новые
            </button>

            <button class="sort-btn {% if current_sort == 'popular' %}active{% endif %}"
                    onclick="setSort('popular')">
                <i class="fas fa-fire"></i> Популярные
            </button>

            <button class="sort-btn {% if current_sort == 'oldest' %}active{% endif %}"
                    onclick="setSort('oldest')">
                <i class="fas fa-history"></i> Сначала старые
            </button>
        </div>
    </div>

    <!-- Активные фильтры -->
    {% if current_category or current_status %}
    <div class="active-filters">
        <span>Активные фильтры:</span>
        {% if current_category %}
        <span class="active-filter">
            Категория: {{ current_category }}
            <button onclick="clearFilter('category')" class="clear-filter-btn">×</button>
        </span>
        {% endif %}
        {% if current_status %}
        <span class="active-filter">
            Статус: {{ current_status }}
            <button onclick="clearFilter('status')" class="clear-filter-btn">×</button>
        </span>
        {% endif %}
        <button onclick="clearAllFilters()" class="clear-all-btn">
            <i class="fas fa-times"></i> Сбросить все фильтры
        </button>
    </div>
    {% endif %}

    <!-- Список жалоб -->
    <div class="complaints-list">
        {% if complaints %}
            {% for complaint in complaints %}
            <div class="complaint-card">
                <div class="complaint-header">
                    <span class="complaint-category category-{{ complaint.category|lower }}">
                        <i class="fas fa-{{
                            'road' if complaint.category == 'Дороги' else
                            'trash' if complaint.category == 'Мусор' else
                            'lightbulb' if complaint.category == 'Освещение' else
                            'tint' if complaint.category == 'Вода' else
                            'bus' if complaint.category == 'Транспорт' else
                            'question-circle'
                        }}"></i>
                        {{ complaint.category }}
                    </span>

                    <span class="complaint-status status-{{ complaint.status|lower|replace(' ', '-') }}">
                        {% if complaint.status == 'Новая' %}
                        <i class="fas fa-clock"></i>
                        {% elif complaint.status == 'В работе' %}
                        <i class="fas fa-tools"></i>
                        {% else %}
                        <i class="fas fa-check-circle"></i>
                        {% endif %}
                        {{ complaint.status }}
                    </span>

                    <span class="complaint-date">
                        <i class="far fa-calendar"></i>
                        {{ complaint.created_at.strftime('%d.%m.%Y') }}
                    </span>
                </div>

                <h3 class="complaint-title">{{ complaint.title }}</h3>

                <p class="complaint-description">{{ complaint.description }}</p>

                {% if complaint.address %}
                <p class="complaint-address">
                    <i class="fas fa-map-marker-alt"></i> {{ complaint.address }}
                </p>
                {% endif %}

                <div class="complaint-footer">
                    <button class="vote-btn" onclick="vote({{ complaint.id }})">
                        <i class="fas fa-thumbs-up"></i> Поддержать
                        <span class="vote-count" id="votes-{{ complaint.id }}">{{ complaint.votes }}</span>
                    </button>

                    <div class="complaint-actions">
                        <button class="action-btn" onclick="shareComplaint({{ complaint.id }})">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="action-btn" onclick="bookmarkComplaint({{ complaint.id }})">
                            <i class="far fa-bookmark"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-complaints">
                <i class="fas fa-inbox fa-3x"></i>
                <h3>Жалоб по выбранным фильтрам нет</h3>
                <p>Попробуйте изменить фильтры или добавьте первую жалобу!</p>
                <a href="{{ url_for('add_complaint') }}" class="btn-primary">
                    <i class="fas fa-plus"></i> Добавить жалобу
                </a>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Установка фильтров
function setCategory(category) {
    const params = new URLSearchParams(window.location.search);
    if (category) {
        params.set('category', category);
    } else {
        params.delete('category');
    }
    window.location.search = params.toString();
}

function setStatus(status) {
    const params = new URLSearchParams(window.location.search);
    if (status) {
        params.set('status', status);
    } else {
        params.delete('status');
    }
    window.location.search = params.toString();
}

function setSort(sort) {
    const params = new URLSearchParams(window.location.search);
    params.set('sort', sort);
    window.location.search = params.toString();
}

// Очистка фильтров
function clearFilter(type) {
    const params = new URLSearchParams(window.location.search);
    params.delete(type);
    window.location.search = params.toString();
}

function clearAllFilters() {
    window.location.search = '';
}

// Голосование
function vote(complaintId) {
    fetch('/vote/' + complaintId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const voteCount = document.getElementById('votes-' + complaintId);
            voteCount.textContent = data.new_count;

            // Анимация
            const btn = voteCount.closest('.vote-btn');
            btn.style.backgroundColor = '#2ecc71';
            setTimeout(() => {
                btn.style.backgroundColor = '';
            }, 500);
        }
    });
}

// Поделиться
function shareComplaint(id) {
    const url = window.location.origin + '/complaint/' + id;
    if (navigator.share) {
        navigator.share({
            title: 'Жалоба на портале',
            text: 'Посмотрите эту жалобу',
            url: url
        });
    } else {
        navigator.clipboard.writeText(url);
        alert('Ссылка скопирована в буфер обмена!');
    }
}

// В закладки
function bookmarkComplaint(id) {
    const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
    if (!bookmarks.includes(id)) {
        bookmarks.push(id);
        localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        alert('Жалоба добавлена в закладки!');
    } else {
        alert('Эта жалоба уже в ваших закладках');
    }
}
</script>
{% endblock %}